# üèóÔ∏è Plataforma de Microservicios ‚Äì Clientes, Facturas y Auditor√≠a

> Sistema distribuido de gesti√≥n empresarial construido con arquitectura de microservicios, implementando Clean Architecture y patrones de dise√±o modernos.

---

## üìã Tabla de Contenidos
- [Descripci√≥n General](#-descripci√≥n-general)
- [Principios Arquitect√≥nicos](#-principios-arquitect√≥nicos)
  - [Arquitectura de Microservicios](#arquitectura-de-microservicios)
  - [Clean Architecture](#clean-architecture)
  - [Patr√≥n MVC](#patr√≥n-mvc)
- [Arquitectura del Sistema](#-arquitectura-del-sistema)
- [Requisitos Previos](#-requisitos-previos)
- [Inicio R√°pido](#-inicio-r√°pido)
- [Infraestructura con Docker Compose](#-infraestructura-con-docker-compose)
- [Microservicios](#-microservicios)
  - [Microservicio de Clientes](#1-microservicio-de-clientes)
  - [Microservicio de Facturas](#2-microservicio-de-facturas)
  - [Microservicio de Auditor√≠a](#3-microservicio-de-auditor√≠a)
- [Pruebas Automatizadas](#-pruebas-automatizadas)
- [Soluci√≥n de Problemas](#-soluci√≥n-de-problemas)
- [Estructura del Proyecto](#-estructura-del-proyecto)

---

## üéØ Descripci√≥n General

Esta plataforma implementa un sistema de gesti√≥n empresarial distribuido en tres microservicios independientes:

- **üßë‚Äçüíº Microservicio de Clientes**: Gestiona el ciclo de vida completo de clientes con persistencia en Oracle Database
- **üìÑ Microservicio de Facturas**: Procesa facturas, valida clientes y mantiene integridad referencial
- **üìä Microservicio de Auditor√≠a**: Centraliza eventos de auditor√≠a de todos los servicios en MongoDB

Cada microservicio es **aut√≥nomo**, **desplegable independientemente** y se comunica mediante **APIs REST** siguiendo principios de dise√±o moderno.

---

## üèõÔ∏è Principios Arquitect√≥nicos

### Arquitectura de Microservicios

La soluci√≥n implementa los siguientes principios fundamentales de microservicios:

#### ‚úÖ **Descomposici√≥n por Dominio de Negocio**
- Cada microservicio representa un **bounded context** espec√≠fico (Clientes, Facturas, Auditor√≠a)
- Responsabilidades claramente definidas y separadas
- Cada servicio gestiona su propio dominio de datos

#### ‚úÖ **Autonom√≠a e Independencia**
- **Base de datos por servicio**: Clientes y Facturas usan Oracle (esquemas separados), Auditor√≠a usa MongoDB
- **Tecnolog√≠as heterog√©neas**: .NET Core (C#) para servicios de negocio, Ruby/Sinatra para auditor√≠a
- **Despliegue independiente**: Cada servicio puede actualizarse sin afectar a los dem√°s

#### ‚úÖ **Comunicaci√≥n mediante APIs REST**
- Interfaces bien definidas con contratos JSON
- Comunicaci√≥n s√≠ncrona HTTP para operaciones de negocio (Facturas ‚Üí Clientes)
- Comunicaci√≥n as√≠ncrona para eventos de auditor√≠a (fire-and-forget)

#### ‚úÖ **Resiliencia y Tolerancia a Fallos**
- Manejo de errores HTTP con c√≥digos de estado apropiados
- Validaciones en cada capa para prevenir propagaci√≥n de errores
- Logs y auditor√≠a para trazabilidad completa

### Clean Architecture

Cada microservicio .NET sigue los principios de **Clean Architecture** (Arquitectura Hexagonal):

#### üì¶ **Capas de la Arquitectura**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         WebApi / Api (Presentation)     ‚îÇ  ‚Üê Controllers, DTOs, Middleware
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ         Application (Use Cases)         ‚îÇ  ‚Üê Services, Interfaces, Mappers
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ         Domain (Business Logic)         ‚îÇ  ‚Üê Entities, Value Objects, Rules
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ    Infrastructure (External Concerns)   ‚îÇ  ‚Üê Repositories, HTTP Clients, DB
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### üéØ **Separaci√≥n de Responsabilidades**

1. **Domain (N√∫cleo del Negocio)**
   - Entidades: `Cliente.cs`, `Factura.cs`
   - L√≥gica de negocio pura sin dependencias externas
   - Validaciones de dominio (ej: monto > 0, email v√°lido)

2. **Application (Casos de Uso)**
   - Servicios: `ClienteService.cs`, `FacturaService.cs`
   - Orquestaci√≥n de operaciones de negocio
   - Interfaces (puertos): `IClienteRepository`, `IClienteGateway`, `IAuditoriaClient`
   - DTOs para transferencia de datos

3. **Infrastructure (Adaptadores)**
   - Implementaciones concretas: `OracleClienteRepository`, `HttpClienteGateway`
   - Acceso a datos con Oracle Managed Data Access
   - Clientes HTTP para comunicaci√≥n entre servicios
   - Configuraci√≥n de base de datos

4. **WebApi/Api (Presentaci√≥n)**
   - Controllers REST: `ClientesController`, `FacturasController`
   - Configuraci√≥n de inyecci√≥n de dependencias
   - Middleware y manejo de errores HTTP

#### ‚ú® **Beneficios Implementados**

- **Testabilidad**: L√≥gica de negocio aislada y f√°cil de probar
- **Mantenibilidad**: Cambios en infraestructura no afectan el dominio
- **Flexibilidad**: F√°cil cambio de base de datos o frameworks
- **Inversi√≥n de dependencias**: El dominio no depende de detalles t√©cnicos

### Patr√≥n MVC

El **Microservicio de Auditor√≠a** (Ruby/Sinatra) implementa una variante del patr√≥n **MVC**:

#### üé≠ **Componentes MVC en Ruby**

1. **Model** (`models/evento.rb`)
   - Representa la entidad de negocio `Evento`
   - Validaciones y normalizaci√≥n de datos
   - Interacci√≥n con MongoDB

2. **View** (Respuestas JSON)
   - Serializaci√≥n autom√°tica a JSON
   - Formato consistente de respuestas HTTP

3. **Controller** (`app.rb`)
   - Endpoints Sinatra que manejan requests HTTP
   - Orquestaci√≥n de operaciones CRUD
   - Manejo de errores y c√≥digos de estado

#### üîÑ **Flujo de Petici√≥n**

```
HTTP Request ‚Üí Controller (app.rb) ‚Üí Model (evento.rb) ‚Üí MongoDB
                    ‚Üì
              JSON Response
```

---

## üèóÔ∏è Arquitectura del Sistema

```mermaid
flowchart TD
    subgraph "Microservicio Clientes (.NET)"
        A[ClientesController<br/>WebApi] --> B[ClienteService<br/>Application]
        B --> C[Cliente<br/>Domain]
        B --> D[OracleClienteRepository<br/>Infrastructure]
        D --> E[(Oracle DB<br/>CLIENTES)]
        B --> F[HttpAuditoriaClient<br/>Infrastructure]
    end
    
    subgraph "Microservicio Facturas (.NET)"
        G[FacturasController<br/>Api] --> H[FacturaService<br/>Application]
        H --> I[Factura<br/>Domain]
        H --> J[OracleFacturaRepository<br/>Infrastructure]
        J --> E
        H --> K[HttpClienteGateway<br/>Infrastructure]
        K -->|Valida Cliente| A
        H --> L[HttpAuditoriaClient<br/>Infrastructure]
    end
    
    subgraph "Microservicio Auditor√≠a (Ruby)"
        M[Sinatra App<br/>app.rb] --> N[Evento Model<br/>models/evento.rb]
        N --> O[(MongoDB<br/>auditoria_db)]
    end
    
    F -->|POST /auditoria| M
    L -->|POST /auditoria| M
    
    style A fill:#e1f5ff
    style G fill:#e1f5ff
    style M fill:#ffe1f5
    style E fill:#fff4e1
    style O fill:#e1ffe1
```

---

## üì¶ Requisitos Previos

### Software Requerido

| Componente | Versi√≥n | Prop√≥sito |
|------------|---------|-----------|
| **.NET SDK** | 7.0+ | Microservicios de Clientes y Facturas |
| **Ruby** | 3.0+ | Microservicio de Auditor√≠a |
| **Bundler** | Latest | Gesti√≥n de gemas Ruby |
| **Docker Compose** | v2+ | Orquestaci√≥n de bases de datos |

### Bases de Datos (via Docker Compose)

| Base de Datos | Versi√≥n | Puerto | Uso |
|---------------|---------|--------|-----|
| **Oracle Database XE** | 21.3.0 | 1521 | Clientes y Facturas |
| **MongoDB** | 6.0 | 27017 | Auditor√≠a |

> **Nota**: Docker Compose gestiona autom√°ticamente la infraestructura de bases de datos. No es necesario instalar Oracle o MongoDB localmente.

---

## üöÄ Inicio R√°pido

### 1Ô∏è‚É£ Levantar Infraestructura

```bash
# Clonar el repositorio
git clone <repository-url>
cd pruebaTecnicaDVP

# Iniciar bases de datos con Docker Compose
docker compose up -d

# Verificar que los servicios est√©n corriendo
docker compose ps

# Ver logs (Oracle puede tardar 2-3 minutos en iniciar)
docker compose logs -f
```

### 2Ô∏è‚É£ Inicializar Base de Datos Oracle

```bash
# Ejecutar script de creaci√≥n de tablas
docker exec -i oracle sqlplus system/oracle123@//localhost:1521/XEPDB1 < scripts/oracle/01-create-tables.sql
```

### 3Ô∏è‚É£ Iniciar Microservicios

**Terminal 1 - Clientes:**
```bash
cd microservicioClientes
dotnet restore
dotnet run --project Clientes.WebApi
# Disponible en http://localhost:5100
```

**Terminal 2 - Facturas:**
```bash
cd microservicioFacturas
dotnet restore
dotnet run --project Facturas.Api
# Disponible en http://localhost:5002
```

**Terminal 3 - Auditor√≠a:**
```bash
cd microservicioAuditoria
bundle install
bundle exec ruby app.rb
# Disponible en http://localhost:5003
```

### 4Ô∏è‚É£ Verificar Funcionamiento

```bash
# Health check de auditor√≠a
curl http://localhost:5003/health

# Crear un cliente
curl -X POST http://localhost:5100/api/clientes \
  -H "Content-Type: application/json" \
  -d '{"nombre":"Juan P√©rez","identificacion":"123456789","correo":"juan@example.com","direccion":"Calle 123"}'

# Listar clientes
curl http://localhost:5100/api/clientes
```

---

## üê≥ Infraestructura con Docker Compose

### Servicios Configurados

El archivo `docker-compose.yml` orquesta dos contenedores de bases de datos:

#### üî∑ Oracle Database 21c Express Edition

```yaml
Imagen: container-registry.oracle.com/database/express:21.3.0-xe
Puerto: 1521 (database), 5500 (web console)
Credenciales:
  - Usuario: system
  - Password: oracle123
  - PDB: XEPDB1
Volumen: oracle-data (persistencia)
Healthcheck: Cada 30s
```

**Conexi√≥n:**
```
system/oracle123@//localhost:1521/XEPDB1
```

#### üü¢ MongoDB 6

```yaml
Imagen: mongo:6
Puerto: 27017
Credenciales:
  - Usuario: admin
  - Password: admin123
Volumen: mongo-data (persistencia)
Base de datos: auditoria_db
```

### Comandos √ötiles

```bash
# Iniciar servicios en segundo plano
docker compose up -d

# Ver logs en tiempo real
docker compose logs -f

# Ver logs de un servicio espec√≠fico
docker compose logs -f oracle
docker compose logs -f mongodb

# Verificar estado de salud
docker inspect oracle --format='{{.State.Health.Status}}'

# Detener servicios
docker compose down

# Detener y eliminar vol√∫menes (‚ö†Ô∏è elimina todos los datos)
docker compose down -v

# Reiniciar un servicio espec√≠fico
docker compose restart oracle
```

### Conectar a las Bases de Datos

**Oracle (SQL*Plus):**
```bash
docker exec -it oracle sqlplus system/oracle123@//localhost:1521/XEPDB1
```

**MongoDB (mongosh):**
```bash
docker exec -it mongodb mongosh -u admin -p admin123
```

### Scripts de Inicializaci√≥n

Los scripts en `scripts/oracle/` y `scripts/mongo/` se ejecutan autom√°ticamente al crear los contenedores por primera vez:

- **`scripts/oracle/01-create-tables.sql`**: Crea tablas CLIENTES y FACTURAS
- **`scripts/mongo/`**: Scripts opcionales de inicializaci√≥n MongoDB

---

## üîß Microservicios

### 1Ô∏è‚É£ Microservicio de Clientes

> **Stack**: .NET 7, ASP.NET Core, Oracle Managed Data Access  
> **Puerto**: 5100  
> **Base de datos**: Oracle (tabla CLIENTES)

#### üìÅ Estructura Clean Architecture

```
microservicioClientes/
‚îú‚îÄ‚îÄ Clientes.Domain/           # Capa de Dominio
‚îÇ   ‚îî‚îÄ‚îÄ Cliente.cs             # Entidad con l√≥gica de negocio
‚îú‚îÄ‚îÄ Clientes.Application/      # Capa de Aplicaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ DTOs/                  # Data Transfer Objects
‚îÇ   ‚îú‚îÄ‚îÄ Interfaces/            # Contratos (IClienteRepository, IAuditoriaClient)
‚îÇ   ‚îî‚îÄ‚îÄ Services/              # ClienteService (casos de uso)
‚îú‚îÄ‚îÄ Clientes.Infrastructure/   # Capa de Infraestructura
‚îÇ   ‚îú‚îÄ‚îÄ OracleClienteRepository.cs  # Persistencia Oracle
‚îÇ   ‚îî‚îÄ‚îÄ HttpAuditoriaClient.cs      # Cliente HTTP auditor√≠a
‚îú‚îÄ‚îÄ Clientes.WebApi/           # Capa de Presentaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ Controllers/           # ClientesController (API REST)
‚îÇ   ‚îî‚îÄ‚îÄ Program.cs             # Configuraci√≥n e inyecci√≥n de dependencias
‚îî‚îÄ‚îÄ Clientes.Tests/            # Pruebas unitarias
```

#### üéØ Funcionalidades

- **Crear cliente**: Validaci√≥n de datos, persistencia en Oracle, registro de auditor√≠a
- **Consultar cliente**: Por ID o listado completo
- **Validaciones de dominio**:
  - Nombre requerido (m√°x. 200 caracteres)
  - Identificaci√≥n √∫nica (m√°x. 50 caracteres)
  - Email v√°lido (formato RFC 5322)
  - Direcci√≥n opcional (m√°x. 300 caracteres)

#### üöÄ Ejecuci√≥n

```bash
cd microservicioClientes
dotnet restore
dotnet test                          # Ejecutar pruebas
dotnet run --project Clientes.WebApi # Iniciar servicio
```

#### üì° API Endpoints

| M√©todo | Endpoint | Descripci√≥n | Request Body |
|--------|----------|-------------|--------------|
| **POST** | `/api/clientes` | Crear nuevo cliente | `CreateClienteDto` |
| **GET** | `/api/clientes/{id}` | Obtener cliente por ID | - |
| **GET** | `/api/clientes` | Listar todos los clientes | - |

#### üìù Ejemplo de Uso

**Crear Cliente:**
```bash
curl -X POST http://localhost:5100/api/clientes \
  -H "Content-Type: application/json" \
  -d '{
    "nombre": "Mar√≠a Gonz√°lez",
    "identificacion": "987654321",
    "correo": "maria.gonzalez@example.com",
    "direccion": "Av. Principal 456"
  }'
```

**Respuesta (201 Created):**
```json
{
  "id": 1,
  "nombre": "Mar√≠a Gonz√°lez",
  "identificacion": "987654321",
  "correo": "maria.gonzalez@example.com",
  "direccion": "Av. Principal 456",
  "fechaCreacion": "2025-10-19T18:30:00Z",
  "activo": true
}
```

---

### 2Ô∏è‚É£ Microservicio de Facturas

> **Stack**: .NET 7, ASP.NET Core, Oracle Managed Data Access, HttpClient  
> **Puerto**: 5002  
> **Base de datos**: Oracle (tabla FACTURAS)

#### üìÅ Estructura Clean Architecture

```
microservicioFacturas/
‚îú‚îÄ‚îÄ Facturas.Domain/           # Capa de Dominio
‚îÇ   ‚îî‚îÄ‚îÄ Factura.cs             # Entidad con reglas de negocio
‚îú‚îÄ‚îÄ Facturas.Application/      # Capa de Aplicaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ DTOs/                  # Data Transfer Objects
‚îÇ   ‚îú‚îÄ‚îÄ Interfaces/            # IFacturaRepository, IClienteGateway, IAuditoriaClient
‚îÇ   ‚îî‚îÄ‚îÄ Services/              # FacturaService (orquestaci√≥n)
‚îú‚îÄ‚îÄ Facturas.Infrastructure/   # Capa de Infraestructura
‚îÇ   ‚îú‚îÄ‚îÄ OracleFacturaRepository.cs  # Persistencia Oracle
‚îÇ   ‚îú‚îÄ‚îÄ HttpClienteGateway.cs       # Cliente HTTP para validar clientes
‚îÇ   ‚îî‚îÄ‚îÄ HttpAuditoriaClient.cs      # Cliente HTTP auditor√≠a
‚îú‚îÄ‚îÄ Facturas.Api/              # Capa de Presentaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ Controllers/           # FacturasController (API REST)
‚îÇ   ‚îî‚îÄ‚îÄ Program.cs             # Configuraci√≥n DI
‚îî‚îÄ‚îÄ Facturas.Tests/            # Pruebas unitarias
```

#### üéØ Funcionalidades

- **Crear factura**: Valida cliente existente, monto positivo, registra auditor√≠a
- **Consultar factura**: Por ID o rango de fechas
- **Integraciones**:
  - Valida existencia de cliente en Microservicio de Clientes (HTTP)
  - Registra eventos en Microservicio de Auditor√≠a (HTTP)
- **Validaciones de dominio**:
  - Cliente ID requerido y existente
  - Monto total > 0
  - Fecha de emisi√≥n v√°lida
  - Estado por defecto: PENDIENTE

#### üöÄ Ejecuci√≥n

```bash
cd microservicioFacturas
dotnet restore
dotnet test                      # Ejecutar pruebas
dotnet run --project Facturas.Api # Iniciar servicio
```

#### üì° API Endpoints

| M√©todo | Endpoint | Descripci√≥n | Query Params |
|--------|----------|-------------|--------------|
| **POST** | `/api/facturas` | Crear nueva factura | - |
| **GET** | `/api/facturas/{id}` | Obtener factura por ID | - |
| **GET** | `/api/facturas` | Listar facturas | `desde`, `hasta` (fechas) |

#### üìù Ejemplo de Uso

**Crear Factura:**
```bash
curl -X POST http://localhost:5002/api/facturas \
  -H "Content-Type: application/json" \
  -d '{
    "clienteId": 1,
    "fechaEmision": "2025-10-19",
    "montoTotal": 250000.50
  }'
```

**Respuesta (201 Created):**
```json
{
  "id": 1,
  "clienteId": 1,
  "fechaEmision": "2025-10-19T00:00:00Z",
  "montoTotal": 250000.50,
  "estado": "PENDIENTE"
}
```

**Listar Facturas por Rango:**
```bash
curl "http://localhost:5002/api/facturas?desde=2025-10-01&hasta=2025-10-31"
```

---

### 3Ô∏è‚É£ Microservicio de Auditor√≠a

> **Stack**: Ruby 3, Sinatra, MongoDB Ruby Driver  
> **Puerto**: 5003  
> **Base de datos**: MongoDB (colecci√≥n eventos)

#### üìÅ Estructura MVC

```
microservicioAuditoria/
‚îú‚îÄ‚îÄ app.rb                     # Controller (endpoints Sinatra)
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îî‚îÄ‚îÄ evento.rb              # Model (entidad Evento)
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ database.rb            # Configuraci√≥n MongoDB
‚îú‚îÄ‚îÄ Gemfile                    # Dependencias Ruby
‚îî‚îÄ‚îÄ README.md                  # Documentaci√≥n espec√≠fica
```

#### üéØ Funcionalidades

- **Registrar eventos**: Normaliza datos, valida campos requeridos, persiste en MongoDB
- **Consultar eventos**: Listar todos o filtrar por entidadId
- **Health check**: Verifica conectividad con MongoDB
- **Normalizaci√≥n autom√°tica**: Soporta camelCase, snake_case, PascalCase
- **Timestamps**: Agrega autom√°ticamente `timestamp` y `fechaCreacion` en UTC

#### üöÄ Ejecuci√≥n

```bash
cd microservicioAuditoria
bundle install                 # Instalar dependencias
bundle exec ruby app.rb        # Iniciar servicio
```

#### üì° API Endpoints

| M√©todo | Endpoint | Descripci√≥n | Respuesta |
|--------|----------|-------------|-----------|
| **POST** | `/auditoria` | Registrar evento | `201 Created` |
| **GET** | `/auditoria` | Listar todos los eventos | Array de eventos |
| **GET** | `/auditoria/{entidadId}` | Buscar por entidad | Array de eventos |
| **GET** | `/health` | Health check | `{"status": "ok"}` |
| **GET** | `/` | Informaci√≥n del servicio | Metadata |

#### üìù Ejemplo de Uso

**Registrar Evento:**
```bash
curl -X POST http://localhost:5003/auditoria \
  -H "Content-Type: application/json" \
  -d '{
    "servicio": "facturas",
    "entidad": "Factura",
    "entidadId": "1",
    "accion": "CREATE",
    "detalles": "Factura creada por $250,000.50"
  }'
```

**Respuesta (201 Created):**
```json
{
  "mensaje": "Evento registrado exitosamente",
  "evento": {
    "_id": "507f1f77bcf86cd799439011",
    "servicio": "facturas",
    "entidad": "Factura",
    "entidadId": "1",
    "accion": "CREATE",
    "detalles": "Factura creada por $250,000.50",
    "timestamp": "2025-10-19T18:35:00.000Z",
    "fechaCreacion": "2025-10-19T18:35:00.000Z"
  }
}
```

**Listar Eventos:**
```bash
curl http://localhost:5003/auditoria
```

**Buscar por Entidad:**
```bash
curl http://localhost:5003/auditoria/1
```

---

## üß™ Pruebas Automatizadas

### Microservicio de Clientes

```bash
cd microservicioClientes
dotnet test --verbosity normal

# Ejecutar pruebas con cobertura
dotnet test /p:CollectCoverage=true
```

**Pruebas incluidas:**
- ‚úÖ Validaciones de entidad `Cliente`
- ‚úÖ Casos de uso en `ClienteService`
- ‚úÖ Mapeo de DTOs
- ‚úÖ Manejo de errores

### Microservicio de Facturas

```bash
cd microservicioFacturas
dotnet test --verbosity normal

# Ejecutar pruebas con cobertura
dotnet test /p:CollectCoverage=true
```

**Pruebas incluidas:**
- ‚úÖ Validaciones de entidad `Factura`
- ‚úÖ Casos de uso en `FacturaService`
- ‚úÖ Integraci√≥n con gateway de clientes
- ‚úÖ Manejo de errores de validaci√≥n

### Microservicio de Auditor√≠a

```bash
cd microservicioAuditoria

# Pruebas manuales con curl
curl http://localhost:5003/health

# Prueba de creaci√≥n de evento
curl -X POST http://localhost:5003/auditoria \
  -H "Content-Type: application/json" \
  -d '{"servicio":"test","entidad":"Test","entidadId":"1","accion":"TEST"}'
```

### Pruebas de Integraci√≥n End-to-End

```bash
# 1. Crear un cliente
CLIENT_ID=$(curl -s -X POST http://localhost:5100/api/clientes \
  -H "Content-Type: application/json" \
  -d '{"nombre":"Test User","identificacion":"TEST123","correo":"test@example.com"}' \
  | jq -r '.id')

# 2. Crear una factura para ese cliente
curl -X POST http://localhost:5002/api/facturas \
  -H "Content-Type: application/json" \
  -d "{\"clienteId\":$CLIENT_ID,\"fechaEmision\":\"2025-10-19\",\"montoTotal\":100000}"

# 3. Verificar eventos de auditor√≠a
curl http://localhost:5003/auditoria
```

---

## üîß Soluci√≥n de Problemas

### üî¥ Problemas con Docker Compose

#### Oracle no inicia
```bash
# Verificar logs
docker compose logs oracle

# Verificar recursos (Oracle requiere m√≠nimo 2GB RAM)
docker stats

# Reiniciar contenedor
docker compose restart oracle

# Esperar m√°s tiempo (puede tardar hasta 5 minutos)
docker compose logs -f oracle | grep "DATABASE IS READY TO USE"
```

#### MongoDB no conecta
```bash
# Verificar estado
docker compose ps mongodb

# Verificar logs
docker compose logs mongodb

# Probar conexi√≥n
docker exec -it mongodb mongosh --eval "db.adminCommand('ping')"
```

#### Puerto ocupado
```bash
# Windows (PowerShell)
netstat -ano | findstr :1521
netstat -ano | findstr :27017

# Detener proceso
taskkill /PID <PID> /F
```

### üü° Problemas con Microservicios .NET

#### Error de conexi√≥n a Oracle
```bash
# Verificar cadena de conexi√≥n en appsettings.json
# Debe ser: "User Id=system;Password=oracle123;Data Source=localhost:1521/XEPDB1"

# Probar conexi√≥n manualmente
docker exec -it oracle sqlplus system/oracle123@//localhost:1521/XEPDB1
```

#### Dependencias no resueltas
```bash
cd microservicioClientes
dotnet clean
dotnet restore --force
dotnet build
```

#### Puerto 5100/5002 ocupado
```bash
# Cambiar puerto en launchSettings.json o usar variable de entorno
export ASPNETCORE_URLS="http://localhost:5101"
dotnet run --project Clientes.WebApi
```

### üü¢ Problemas con Microservicio Ruby

#### Gemas no instaladas
```bash
cd microservicioAuditoria
bundle install --path vendor/bundle
bundle exec ruby app.rb
```

#### Error de conexi√≥n MongoDB
```bash
# Verificar configuraci√≥n en config/database.rb
# Por defecto: mongodb://localhost:27017/auditoria_db

# Si MongoDB tiene autenticaci√≥n:
# mongodb://admin:admin123@localhost:27017/auditoria_db?authSource=admin
```

#### Puerto 5003 ocupado
```bash
# Cambiar puerto en app.rb
# set :port, 5004

# O usar variable de entorno
PORT=5004 bundle exec ruby app.rb
```

### ‚ö†Ô∏è Errores Comunes de API

| Error | Causa | Soluci√≥n |
|-------|-------|----------|
| **ORA-00001: unique constraint violated** | Identificaci√≥n de cliente duplicada | Usar identificaci√≥n √∫nica |
| **400 Bad Request - Cliente no existe** | ClienteId inv√°lido en factura | Verificar que el cliente exista primero |
| **400 Bad Request - Datos inv√°lidos** | JSON malformado o campos faltantes | Validar estructura JSON |
| **500 Internal Server Error** | Error de base de datos o servicio ca√≠do | Revisar logs del servicio |
| **503 Service Unavailable** | Servicio dependiente no disponible | Verificar que todos los servicios est√©n corriendo |

---

## üìÇ Estructura del Proyecto

```
pruebaTecnicaDVP/
‚îÇ
‚îú‚îÄ‚îÄ üìÑ README.md                          # Este archivo (documentaci√≥n completa)
‚îú‚îÄ‚îÄ üê≥ docker-compose.yml                 # Orquestaci√≥n de bases de datos
‚îÇ
‚îú‚îÄ‚îÄ üìÅ microservicioClientes/             # Microservicio .NET - Clientes
‚îÇ   ‚îú‚îÄ‚îÄ Clientes.Domain/                  # Entidades y l√≥gica de negocio
‚îÇ   ‚îú‚îÄ‚îÄ Clientes.Application/             # Casos de uso y DTOs
‚îÇ   ‚îú‚îÄ‚îÄ Clientes.Infrastructure/          # Repositorios y clientes HTTP
‚îÇ   ‚îú‚îÄ‚îÄ Clientes.WebApi/                  # API REST (puerto 5100)
‚îÇ   ‚îî‚îÄ‚îÄ Clientes.Tests/                   # Pruebas unitarias
‚îÇ
‚îú‚îÄ‚îÄ üìÅ microservicioFacturas/             # Microservicio .NET - Facturas
‚îÇ   ‚îú‚îÄ‚îÄ Facturas.Domain/                  # Entidades y reglas de negocio
‚îÇ   ‚îú‚îÄ‚îÄ Facturas.Application/             # Casos de uso y DTOs
‚îÇ   ‚îú‚îÄ‚îÄ Facturas.Infrastructure/          # Repositorios y gateways
‚îÇ   ‚îú‚îÄ‚îÄ Facturas.Api/                     # API REST (puerto 5002)
‚îÇ   ‚îî‚îÄ‚îÄ Facturas.Tests/                   # Pruebas unitarias
‚îÇ
‚îú‚îÄ‚îÄ üìÅ microservicioAuditoria/            # Microservicio Ruby - Auditor√≠a
‚îÇ   ‚îú‚îÄ‚îÄ app.rb                            # Aplicaci√≥n Sinatra (puerto 5003)
‚îÇ   ‚îú‚îÄ‚îÄ models/evento.rb                  # Modelo de eventos
‚îÇ   ‚îú‚îÄ‚îÄ config/database.rb                # Configuraci√≥n MongoDB
‚îÇ   ‚îú‚îÄ‚îÄ Gemfile                           # Dependencias Ruby
‚îÇ   ‚îî‚îÄ‚îÄ README.md                         # Documentaci√≥n espec√≠fica
‚îÇ
‚îî‚îÄ‚îÄ üìÅ scripts/                           # Scripts de inicializaci√≥n
    ‚îú‚îÄ‚îÄ oracle/
    ‚îÇ   ‚îî‚îÄ‚îÄ 01-create-tables.sql          # DDL para tablas Oracle
    ‚îî‚îÄ‚îÄ mongo/
        ‚îî‚îÄ‚îÄ (scripts opcionales)
```

---

## üéì Resumen de Tecnolog√≠as

| Componente | Tecnolog√≠as |
|------------|-------------|
| **Microservicios .NET** | C#, .NET 7, ASP.NET Core, Oracle.ManagedDataAccess |
| **Microservicio Ruby** | Ruby 3, Sinatra, MongoDB Ruby Driver |
| **Bases de Datos** | Oracle Database 21c XE, MongoDB 6 |
| **Contenedores** | Docker, Docker Compose |
| **Patrones** | Clean Architecture, Microservicios, MVC, Repository, Gateway |
| **Comunicaci√≥n** | REST APIs, HTTP/JSON |
| **Testing** | xUnit, Moq (para .NET) |

---

## üìö Recursos Adicionales

### Documentaci√≥n de APIs

- **Swagger UI Clientes**: http://localhost:5100/swagger (si est√° habilitado)
- **Swagger UI Facturas**: http://localhost:5002/swagger (si est√° habilitado)

### Monitoreo

```bash
# Ver logs en tiempo real de todos los servicios
docker compose logs -f

# Monitorear recursos
docker stats

# Ver procesos .NET
dotnet --list-runtimes
```

---

## üë®‚Äçüíª Autor

**Juan Camilo Rodriguez Amaya**

**Proyecto de Prueba T√©cnica - Arquitectura de Microservicios**

Implementaci√≥n de sistema distribuido con Clean Architecture, siguiendo principios SOLID y mejores pr√°cticas de desarrollo.

---

## üìù Licencia

Este proyecto es parte de una prueba t√©cnica y est√° disponible para fines educativos y de evaluaci√≥n.

---

<div align="center">

**üöÄ ¬°Gracias por revisar este proyecto! üöÄ**

*Construido con ‚ù§Ô∏è usando .NET, Ruby, Oracle y MongoDB*

</div>
